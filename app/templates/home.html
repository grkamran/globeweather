{% extends "base.html" %}
{% block title %}GlobeWeather{% endblock %}

{% block content %}
<div class="layout">

  <div class="topbar">
    <div class="brand">
      <button class="profilebtn" id="menuBtn" type="button" aria-label="Menu">
        <div class="logo"></div>
      </button>

      <b id="brandTitle">Weather</b>

      <!-- MENU -->
      <div class="menu" id="menu">
        <!-- MAIN -->
        <div id="menuMain">
          <div class="menu-title" id="menuTitle">Menu</div>

          <div class="menu-item" id="menuLanguage">
            <div class="menu-left">
              <div class="menu-ico">üåê</div>
              <div class="menu-meta">
                <b id="langTitle">Language</b>
                <span id="langSubtitle">Change UI language</span>
              </div>
            </div>
            <div class="menu-right" id="openText1">Open</div>
          </div>

          <div class="menu-item" id="menuContacts">
            <div class="menu-left">
              <div class="menu-ico">üì©</div>
              <div class="menu-meta">
                <b id="contactsTitle">Contacts</b>
                <span id="contactsSubtitle">Contact support</span>
              </div>
            </div>
            <div class="menu-right" id="openText2">Open</div>
          </div>
        </div>

        <!-- CONTACTS PANEL -->
        <div id="menuContactsPanel" style="display:none;">
          <div class="menu-title" id="contactsPanelTitle">Contacts</div>

          <div class="menu-item" id="openEmail">
            <div class="menu-left">
              <div class="menu-ico">‚úâÔ∏è</div>
              <div class="menu-meta">
                <b id="emailTitle">Email</b>
                <span>kkaraev1@stu.vistula.edu.pl</span>
              </div>
            </div>
            <div class="menu-right" id="openText3">Open</div>
          </div>

          <div class="menu-item" id="openInsta">
            <div class="menu-left">
              <div class="menu-ico">üì∑</div>
              <div class="menu-meta">
                <b id="instaTitle">Instagram</b>
                <span>@grkamran</span>
              </div>
            </div>
            <div class="menu-right" id="openText4">Open</div>
          </div>

          <button class="menu-back" id="backToMenu1" type="button">‚Üê Back</button>
        </div>

        <!-- LANGUAGE PANEL -->
        <div id="menuLanguagePanel" style="display:none;">
          <div class="menu-title" id="languagePanelTitle">Choose language</div>

          <div class="menu-item" data-lang="en">
            <div class="menu-left">
              <div class="menu-ico">üá¨üáß</div>
              <div class="menu-meta">
                <b>English</b>
                <span>EN</span>
              </div>
            </div>
            <div class="menu-right" id="selectText1">Select</div>
          </div>

          <div class="menu-item" data-lang="ru">
            <div class="menu-left">
              <div class="menu-ico">üá∑üá∫</div>
              <div class="menu-meta">
                <b>–†—É—Å—Å–∫–∏–π</b>
                <span>RU</span>
              </div>
            </div>
            <div class="menu-right" id="selectText2">Select</div>
          </div>

          <div class="menu-item" data-lang="tr">
            <div class="menu-left">
              <div class="menu-ico">üáπüá∑</div>
              <div class="menu-meta">
                <b>T√ºrk√ße</b>
                <span>TR</span>
              </div>
            </div>
            <div class="menu-right" id="selectText3">Select</div>
          </div>

          <div class="menu-item" data-lang="uk">
            <div class="menu-left">
              <div class="menu-ico">üá∫üá¶</div>
              <div class="menu-meta">
                <b>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</b>
                <span>UK</span>
              </div>
            </div>
            <div class="menu-right" id="selectText4">Select</div>
          </div>

          <div class="menu-item" data-lang="pl">
            <div class="menu-left">
              <div class="menu-ico">üáµüá±</div>
              <div class="menu-meta">
                <b>Polski</b>
                <span>PL</span>
              </div>
            </div>
            <div class="menu-right" id="selectText5">Select</div>
          </div>

          <button class="menu-back" id="backToMenu2" type="button">‚Üê Back</button>
        </div>
      </div>
    </div>

    <!-- Search input (FULL WIDTH like Google Maps) -->
    <div class="searchwrap">
      <input id="q" placeholder="Search city" autocomplete="off" />
      <div id="suggestBox" class="suggestbox" style="display:none;"></div>
    </div>

    <div class="statuspill" id="status">
      <span class="spin"></span>
      <span id="statusText">Ready</span>
    </div>
  </div>

  <section class="map-panel">
    <div id="map" aria-label="Map"></div>
  </section>

  <aside class="right">
    <div class="right-title">
      <b id="rightTitle">Next 4 days</b>
      <span class="tag" id="rtag">‚Äî</span>
    </div>

    <div class="citylist" id="daylist">
      <div class="citycard" id="placeholderCard">
        <div class="city-left">
          <div class="ico">üîé</div>
          <div class="city-meta">
            <b id="phTitle">Search a city</b>
            <span id="phSub">Type a city name and pick a suggestion to show the next 4 days forecast.</span>
          </div>
        </div>
        <div class="city-temp" style="opacity:.75;">‚Äî</div>
      </div>
    </div>
  </aside>

  <section class="bottom">
    <div class="bottom-head">
      <b id="sunTimeTitle">Sun ‚Ä¢ Time</b>
      <span class="tag" id="updated">‚Äî</span>
    </div>

    <div
      style="
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        border-radius: 16px;
        padding: 10px;
        display:flex;
        flex-direction:column;
        gap:8px;
        overflow:hidden;
      "
    >
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span id="localTimeLabel" style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Local time</span>
        <b id="localtime" style="font-size:14px; letter-spacing:.2px;">‚Äî</b>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span id="sunriseLabel" style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Sunrise</span>
        <b id="sunrise" style="font-size:14px; letter-spacing:.2px;">‚Äî</b>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span id="sunsetLabel" style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Sunset</span>
        <b id="sunset" style="font-size:14px; letter-spacing:.2px;">‚Äî</b>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span id="dayLenLabel" style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Day length</span>
        <b id="daylen" style="font-size:14px; letter-spacing:.2px;">‚Äî</b>
      </div>
    </div>
  </section>

</div>

<!-- ‚úÖ EASTER EGG OVERLAY (Ratne Anna) -->
<div id="loveOverlay" class="love-overlay" aria-hidden="true">
  <div class="love-bg"></div>
  <div class="love-hearts" id="loveHearts"></div>
</div>

<!-- ‚úÖ Suggestions CSS (small, clean, google-like) -->
<style>
  .suggestbox{
    position:absolute;
    top:52px;
    left:0;
    right:0;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.16);
    background: linear-gradient(180deg, rgba(16,20,52,.96), rgba(10,14,36,.92));
    backdrop-filter: blur(14px);
    box-shadow: 0 26px 90px rgba(0,0,0,.62);
    overflow:hidden;
    z-index: 99999;
    padding: 8px;
  }
  .sug-item{
    width:100%;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    border-radius: 14px;
    padding: 10px 10px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom: 8px;
  }
  .sug-item:last-child{ margin-bottom: 0; }
  .sug-item:hover,
  .sug-item.active{
    border-color: rgba(6,182,212,.35);
    box-shadow: 0 0 0 4px rgba(6,182,212,.10);
  }
  .sug-ico{
    width:34px;height:34px;border-radius: 14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    display:flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
  }
  .sug-meta{ min-width:0; }
  .sug-meta b{
    display:block;
    font-size: 13px;
    font-weight: 950;
    letter-spacing:.2px;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .sug-meta span{
    display:block;
    margin-top: 3px;
    color: rgba(255,255,255,.62);
    font-family: ui-monospace,monospace;
    font-size: 11px;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .sug-empty{
    border:1px dashed rgba(255,255,255,.18);
    background: rgba(255,255,255,.04);
    border-radius: 14px;
    padding: 10px;
    color: rgba(255,255,255,.62);
    font-family: ui-monospace,monospace;
    font-size: 12px;
  }

  /* ‚úÖ LOVE OVERLAY */
  .love-overlay{
    position: fixed;
    inset: 0;
    z-index: 9999999;
    display: none;
    pointer-events: none;
  }
  .love-overlay.show{ display:block; }

  .love-bg{
    position:absolute;
    inset:0;
    background: #000;
    transition: background 1.2s ease;
  }
  .love-overlay.pink .love-bg{
    background: #ff4fa3; /* —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω */
  }

  .love-hearts{
    position:absolute;
    inset:0;
    overflow:hidden;
  }

  .love-heart{
    position:absolute;
    bottom: -80px;
    left: 50%;
    font-size: 28px;
    opacity: 0.0;
    transform: translateX(-50%);
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    animation: love-rise linear forwards;
    user-select:none;
    will-change: transform, opacity;
  }

  @keyframes love-rise{
    0%{
      transform: translateX(var(--x)) translateY(0) scale(var(--s)) rotate(var(--r));
      opacity: 0;
    }
    10%{ opacity: .95; }
    60%{ opacity: .95; }
    100%{
      transform: translateX(calc(var(--x) + var(--drift))) translateY(calc(-1 * var(--h))) scale(var(--s)) rotate(calc(var(--r) + 40deg));
      opacity: 0;
    }
  }
</style>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // =========================
  // i18n (UI Language)
  // =========================
  const I18N = {
    en: {
      brandTitle: "Weather",
      menuTitle: "Menu",
      langTitle: "Language",
      langSubtitle: "Change UI language",
      contactsTitle: "Contacts",
      contactsSubtitle: "Contact support",
      open: "Open",
      select: "Select",
      back: "‚Üê Back",
      languagePanelTitle: "Choose language",
      searchPlaceholder: "Search city",
      ready: "Ready",
      typeCityName: "Type a city name",
      next4days: "Next 4 days",
      placeholderTitle: "Search a city",
      placeholderSub: "Type a city name and pick a suggestion to show the next 4 days forecast.",
      sunTime: "Sun ‚Ä¢ Time",
      localTime: "Local time",
      sunrise: "Sunrise",
      sunset: "Sunset",
      dayLen: "Day length",
      updated: "Updated",
      hum: "Hum",
      wind: "Wind",
      ms: "m/s",
      searching: "Searching‚Ä¶",
      done: "Done",
      errorPrefix: "Error: ",
      noForecastTitle: "No forecast",
      tryAnotherCity: "Try another city",
      noSuggestions: "No matches",
    },

    ru: {
      brandTitle: "–ü–æ–≥–æ–¥–∞",
      menuTitle: "–ú–µ–Ω—é",
      langTitle: "–Ø–∑—ã–∫",
      langSubtitle: "–ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
      contactsTitle: "–ö–æ–Ω—Ç–∞–∫—Ç—ã",
      contactsSubtitle: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",
      open: "–û—Ç–∫—Ä—ã—Ç—å",
      select: "–í—ã–±—Ä–∞—Ç—å",
      back: "‚Üê –ù–∞–∑–∞–¥",
      languagePanelTitle: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫",
      searchPlaceholder: "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥",
      ready: "–ì–æ—Ç–æ–≤–æ",
      typeCityName: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞",
      next4days: "–°–ª–µ–¥—É—é—â–∏–µ 4 –¥–Ω—è",
      placeholderTitle: "–ù–∞–π–¥–∏—Ç–µ –≥–æ—Ä–æ–¥",
      placeholderSub: "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 4 –¥–Ω—è.",
      sunTime: "–°–æ–ª–Ω—Ü–µ ‚Ä¢ –í—Ä–µ–º—è",
      localTime: "–ú–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è",
      sunrise: "–í–æ—Å—Ö–æ–¥",
      sunset: "–ó–∞–∫–∞—Ç",
      dayLen: "–î–ª–∏–Ω–∞ –¥–Ω—è",
      updated: "–û–±–Ω–æ–≤–ª–µ–Ω–æ",
      hum: "–í–ª–∞–∂–Ω.",
      wind: "–í–µ—Ç–µ—Ä",
      ms: "–º/—Å",
      searching: "–ü–æ–∏—Å–∫‚Ä¶",
      done: "–ì–æ—Ç–æ–≤–æ",
      errorPrefix: "–û—à–∏–±–∫–∞: ",
      noForecastTitle: "–ù–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞",
      tryAnotherCity: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥",
      noSuggestions: "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
    },

    tr: {
      brandTitle: "Hava",
      menuTitle: "Men√º",
      langTitle: "Dil",
      langSubtitle: "Aray√ºz dilini deƒüi≈ütir",
      contactsTitle: "ƒ∞leti≈üim",
      contactsSubtitle: "Destek ile ileti≈üime ge√ß",
      open: "A√ß",
      select: "Se√ß",
      back: "‚Üê Geri",
      languagePanelTitle: "Dil se√ßin",
      searchPlaceholder: "≈ûehir ara",
      ready: "Hazƒ±r",
      typeCityName: "Bir ≈üehir adƒ± yaz",
      next4days: "√ñn√ºm√ºzdeki 4 g√ºn",
      placeholderTitle: "≈ûehir ara",
      placeholderSub: "≈ûehir yaz ve √∂nerilerden se√ß. 4 g√ºnl√ºk tahmin g√∂sterilecek.",
      sunTime: "G√ºne≈ü ‚Ä¢ Saat",
      localTime: "Yerel saat",
      sunrise: "G√ºn doƒüumu",
      sunset: "G√ºn batƒ±mƒ±",
      dayLen: "G√ºn uzunluƒüu",
      updated: "G√ºncellendi",
      hum: "Nem",
      wind: "R√ºzgar",
      ms: "m/sn",
      searching: "Aranƒ±yor‚Ä¶",
      done: "Bitti",
      errorPrefix: "Hata: ",
      noForecastTitle: "Tahmin yok",
      tryAnotherCity: "Ba≈üka bir ≈üehir deneyin",
      noSuggestions: "Sonu√ß yok",
    },

    uk: {
      brandTitle: "–ü–æ–≥–æ–¥–∞",
      menuTitle: "–ú–µ–Ω—é",
      langTitle: "–ú–æ–≤–∞",
      langSubtitle: "–ó–º—ñ–Ω–∏—Ç–∏ –º–æ–≤—É —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É",
      contactsTitle: "–ö–æ–Ω—Ç–∞–∫—Ç–∏",
      contactsSubtitle: "–ó–≤‚Äô—è–∑–∞—Ç–∏—Å—è –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é",
      open: "–í—ñ–¥–∫—Ä–∏—Ç–∏",
      select: "–û–±—Ä–∞—Ç–∏",
      back: "‚Üê –ù–∞–∑–∞–¥",
      languagePanelTitle: "–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É",
      searchPlaceholder: "–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞",
      ready: "–ì–æ—Ç–æ–≤–æ",
      typeCityName: "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞",
      next4days: "–ù–∞—Å—Ç—É–ø–Ω—ñ 4 –¥–Ω—ñ",
      placeholderTitle: "–ó–Ω–∞–π–¥—ñ—Ç—å –º—ñ—Å—Ç–æ",
      placeholderSub: "–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ç–æ —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å –ø—ñ–¥–∫–∞–∑–∫—É. –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 4 –¥–Ω—ñ.",
      sunTime: "–°–æ–Ω—Ü–µ ‚Ä¢ –ß–∞—Å",
      localTime: "–ú—ñ—Å—Ü–µ–≤–∏–π —á–∞—Å",
      sunrise: "–°—Ö—ñ–¥",
      sunset: "–ó–∞—Ö—ñ–¥",
      dayLen: "–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –¥–Ω—è",
      updated: "–û–Ω–æ–≤–ª–µ–Ω–æ",
      hum: "–í–æ–ª–æ–≥.",
      wind: "–í—ñ—Ç–µ—Ä",
      ms: "–º/—Å",
      searching: "–ü–æ—à—É–∫‚Ä¶",
      done: "–ì–æ—Ç–æ–≤–æ",
      errorPrefix: "–ü–æ–º–∏–ª–∫–∞: ",
      noForecastTitle: "–ù–µ–º–∞—î –ø—Ä–æ–≥–Ω–æ–∑—É",
      tryAnotherCity: "–°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–µ –º—ñ—Å—Ç–æ",
      noSuggestions: "–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ",
    },

    pl: {
      brandTitle: "Pogoda",
      menuTitle: "Menu",
      langTitle: "Jƒôzyk",
      langSubtitle: "Zmie≈Ñ jƒôzyk interfejsu",
      contactsTitle: "Kontakt",
      contactsSubtitle: "Skontaktuj siƒô ze wsparciem",
      open: "Otw√≥rz",
      select: "Wybierz",
      back: "‚Üê Wr√≥ƒá",
      languagePanelTitle: "Wybierz jƒôzyk",
      searchPlaceholder: "Szukaj miasta",
      ready: "Gotowe",
      typeCityName: "Wpisz nazwƒô miasta",
      next4days: "Kolejne 4 dni",
      placeholderTitle: "Wyszukaj miasto",
      placeholderSub: "Wpisz miasto i wybierz podpowied≈∫, aby zobaczyƒá prognozƒô na 4 dni.",
      sunTime: "S≈Ço≈Ñce ‚Ä¢ Czas",
      localTime: "Czas lokalny",
      sunrise: "Wsch√≥d s≈Ço≈Ñca",
      sunset: "Zach√≥d s≈Ço≈Ñca",
      dayLen: "D≈Çugo≈õƒá dnia",
      updated: "Zaktualizowano",
      hum: "Wilg.",
      wind: "Wiatr",
      ms: "m/s",
      searching: "Szukanie‚Ä¶",
      done: "Gotowe",
      errorPrefix: "B≈ÇƒÖd: ",
      noForecastTitle: "Brak prognozy",
      tryAnotherCity: "Spr√≥buj inne miasto",
      noSuggestions: "Brak wynik√≥w",
    },
  };

  function getLang() {
    return localStorage.getItem("gw_lang") || "en";
  }

  function t(key){
    const lang = getLang();
    return (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : (I18N.en[key] || key);
  }

  function localeForLang(lang){
    switch((lang || "en").toLowerCase()){
      case "ru": return "ru-RU";
      case "uk": return "uk-UA";
      case "tr": return "tr-TR";
      case "pl": return "pl-PL";
      default: return "en-US";
    }
  }

  function applyLang(lang){
    $("brandTitle").textContent = I18N[lang].brandTitle;
    $("q").placeholder = I18N[lang].searchPlaceholder;

    $("menuTitle").textContent = I18N[lang].menuTitle;

    $("langTitle").textContent = I18N[lang].langTitle;
    $("langSubtitle").textContent = I18N[lang].langSubtitle;

    $("contactsTitle").textContent = I18N[lang].contactsTitle;
    $("contactsSubtitle").textContent = I18N[lang].contactsSubtitle;

    $("openText1").textContent = I18N[lang].open;
    $("openText2").textContent = I18N[lang].open;
    $("openText3").textContent = I18N[lang].open;
    $("openText4").textContent = I18N[lang].open;

    $("selectText1").textContent = I18N[lang].select;
    $("selectText2").textContent = I18N[lang].select;
    $("selectText3").textContent = I18N[lang].select;
    $("selectText4").textContent = I18N[lang].select;
    $("selectText5").textContent = I18N[lang].select;

    $("contactsPanelTitle").textContent = I18N[lang].contactsTitle;
    $("emailTitle").textContent =
      (lang === "ru") ? "–ü–æ—á—Ç–∞" :
      (lang === "uk") ? "–ü–æ—à—Ç–∞" :
      (lang === "tr") ? "E-posta" :
      (lang === "pl") ? "Email" : "Email";
    $("instaTitle").textContent = "Instagram";

    $("backToMenu1").textContent = I18N[lang].back;
    $("backToMenu2").textContent = I18N[lang].back;
    $("languagePanelTitle").textContent = I18N[lang].languagePanelTitle;

    $("rightTitle").textContent = I18N[lang].next4days;

    $("phTitle").textContent = I18N[lang].placeholderTitle;
    $("phSub").textContent = I18N[lang].placeholderSub;

    $("sunTimeTitle").textContent = I18N[lang].sunTime;
    $("localTimeLabel").textContent = I18N[lang].localTime;
    $("sunriseLabel").textContent = I18N[lang].sunrise;
    $("sunsetLabel").textContent = I18N[lang].sunset;
    $("dayLenLabel").textContent = I18N[lang].dayLen;

    const st = $("statusText").textContent.trim();
    if (st && ["Ready","–ì–æ—Ç–æ–≤–æ","Hazƒ±r","Gotowe"].includes(st)) {
      $("statusText").textContent = I18N[lang].ready;
    }
  }

  // =========================
  // MENU LOGIC
  // =========================
  const menuBtn = $("menuBtn");
  const menu = $("menu");

  const menuMain = $("menuMain");
  const menuContactsPanel = $("menuContactsPanel");
  const menuLanguagePanel = $("menuLanguagePanel");

  function showMain(){
    menuMain.style.display = "block";
    menuContactsPanel.style.display = "none";
    menuLanguagePanel.style.display = "none";
  }
  function showContacts(){
    menuMain.style.display = "none";
    menuContactsPanel.style.display = "block";
    menuLanguagePanel.style.display = "none";
  }
  function showLanguage(){
    menuMain.style.display = "none";
    menuContactsPanel.style.display = "none";
    menuLanguagePanel.style.display = "block";
  }

  function openMenu(){ menu.classList.add("show"); }
  function closeMenu(){
    menu.classList.remove("show");
    showMain();
  }

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if(menu.classList.contains("show")) closeMenu();
    else openMenu();
  });

  document.addEventListener("click", () => closeMenu());
  menu.addEventListener("click", (e) => e.stopPropagation());

  $("menuLanguage").addEventListener("click", () => showLanguage());
  $("menuContacts").addEventListener("click", () => showContacts());

  $("backToMenu1").addEventListener("click", () => showMain());
  $("backToMenu2").addEventListener("click", () => showMain());

  menuLanguagePanel.addEventListener("click", (e) => {
    const item = e.target.closest(".menu-item[data-lang]");
    if(!item) return;
    const lang = item.getAttribute("data-lang");
    localStorage.setItem("gw_lang", lang);
    location.reload();
  });

  $("openEmail").addEventListener("click", () => {
    window.location.href = "mailto:kkaraev1@stu.vistula.edu.pl";
  });
  $("openInsta").addEventListener("click", () => {
    window.open("https://www.instagram.com/grkamran/", "_blank", "noopener,noreferrer");
  });

  // =========================
  // ‚úÖ EASTER EGG: "–†–∞—Ç–Ω–µ –∞–Ω–Ω–∞"
  // =========================
  const loveOverlay = $("loveOverlay");
  const loveHearts = $("loveHearts");
  let loveRunning = false;

  function normalizeQuery(s){
    return String(s || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " "); // –º–Ω–æ–≥–æ –ø—Ä–æ–±–µ–ª–æ–≤ -> –æ–¥–∏–Ω
  }

  function startLoveEasterEgg(){
    if(loveRunning) return;
    loveRunning = true;

    // show overlay, start black
    loveOverlay.classList.add("show");
    loveOverlay.classList.remove("pink");
    loveHearts.innerHTML = "";

    // —á—É—Ç—å –ø–æ–∑–∂–µ –¥–µ–ª–∞–µ–º —Ä–æ–∑–æ–≤—ã–π (—á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ —Å–º–µ–Ω—É)
    setTimeout(() => {
      loveOverlay.classList.add("pink");
    }, 400);

    // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ä–¥–µ—á–µ–∫
    const hearts = ["üíó","üíñ","üíò","üíï","üíû","üíì"];
    const start = Date.now();

    function spawnHeart(){
      const h = document.createElement("div");
      h.className = "love-heart";
      h.textContent = hearts[Math.floor(Math.random() * hearts.length)];

      const left = Math.random() * 100;         // %
      const scale = 0.7 + Math.random() * 1.3;  // 0.7..2.0
      const height = 550 + Math.random() * 650; // px
      const drift = (-80 + Math.random() * 160); // px
      const rot = (-25 + Math.random() * 50);    // deg
      const dur = 3.2 + Math.random() * 2.8;     // sec

      h.style.left = left + "%";
      h.style.setProperty("--x", "0px");
      h.style.setProperty("--s", scale.toFixed(2));
      h.style.setProperty("--h", height.toFixed(0) + "px");
      h.style.setProperty("--drift", drift.toFixed(0) + "px");
      h.style.setProperty("--r", rot.toFixed(0) + "deg");
      h.style.animationDuration = dur.toFixed(2) + "s";

      loveHearts.appendChild(h);

      // —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      setTimeout(() => {
        h.remove();
      }, (dur + 0.2) * 1000);
    }

    const interval = setInterval(() => {
      // —á—É—Ç—å –ø–ª–æ—Ç–Ω–µ–µ ‚Äú—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö‚Äù
      spawnHeart();
      if(Math.random() > 0.55) spawnHeart();

      if(Date.now() - start >= 10000){
        clearInterval(interval);
      }
    }, 140);

    // —á–µ—Ä–µ–∑ 10 —Å–µ–∫ ‚Äú–∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–π—Ç –∑–∞–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã–ª—Å—è‚Äù
    setTimeout(() => {
      location.reload();
    }, 10000);
  }

  // =========================
  // WEATHER APP
  // =========================
  const statusEl = $("status");
  const statusText = $("statusText");

  function setStatus(text, mode="ready"){
    statusText.textContent = text;
    statusEl.classList.toggle("loading", mode === "loading");
    statusText.classList.toggle("err", mode === "error");
  }

  function nowTime(){
    return new Date().toLocaleTimeString(localeForLang(getLang()), {hour:"2-digit", minute:"2-digit"});
  }

  function fmtLocalClockFromOffset(offsetSeconds){
    const nowUtcMs = Date.now();
    const localMs = nowUtcMs + (offsetSeconds * 1000);
    const d = new Date(localMs);
    return d.toLocaleTimeString(localeForLang(getLang()), {hour:"2-digit", minute:"2-digit"});
  }

  const map = L.map("map", {
    zoomControl:true,
    preferCanvas:true,
    minZoom: 2
  }).setView([20,10], 2);

  const worldBounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
  map.setMaxBounds(worldBounds);
  map.on("drag", () => map.panInsideBounds(worldBounds, { animate:false }));

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let pinMarker = null;

  function makePinCard(minT, maxT, desc, hum, wind){
    return `
      <div class="pin-card" style="width: 180px; text-align:left; padding:12px 12px 12px;">
        <div style="font-weight:950; font-size:22px; letter-spacing:.2px;">
          ${Math.round(minT)}¬∞/${Math.round(maxT)}¬∞
        </div>
        <div style="margin-top:6px; font-size:12px; color:rgba(255,255,255,.78);">
          ${desc || "‚Äî"}
        </div>
        <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,.78);">
          ${t("hum")} ${hum ?? "‚Äî"}%
        </div>
        <div style="margin-top:4px; font-size:12px; color:rgba(255,255,255,.78);">
          ${t("wind")} ${wind ?? "‚Äî"} ${t("ms")}
        </div>
      </div>
    `;
  }

  function setPin(lat, lon, minT, maxT, desc, hum, wind){
    const icon = L.divIcon({
      className: "",
      html: makePinCard(minT, maxT, desc, hum, wind),
      iconSize: [180, 118],
      iconAnchor: [90, 118]
    });

    if (pinMarker) map.removeLayer(pinMarker);
    pinMarker = L.marker([lat, lon], { icon }).addTo(map);
  }

  async function apiSearch(city){
    const lang = getLang();
    const res = await fetch(`/api/search/?city=${encodeURIComponent(city)}&lang=${encodeURIComponent(lang)}`);
    const data = await res.json().catch(() => ({}));
    if(!res.ok){
      const msg = data?.error || "Request failed";
      throw new Error(msg);
    }
    return data;
  }

  async function apiSuggest(q){
    const lang = getLang();
    const res = await fetch(`/api/suggest/?q=${encodeURIComponent(q)}&lang=${encodeURIComponent(lang)}&limit=7`);
    const data = await res.json().catch(() => ({}));
    if(!res.ok){
      return { suggestions: [] };
    }
    return data;
  }

  function dayLabel(iso){
    const d = new Date(iso + "T00:00:00");
    return d.toLocaleDateString(localeForLang(getLang()), { weekday:"short", month:"short", day:"numeric" });
  }

  function iconFor(desc=""){
    const txt = (desc || "").toLowerCase();
    if (txt.includes("rain")) return "üåßÔ∏è";
    if (txt.includes("cloud")) return "‚òÅÔ∏è";
    if (txt.includes("snow")) return "üå®Ô∏è";
    if (txt.includes("storm") || txt.includes("thunder")) return "‚õàÔ∏è";
    if (txt.includes("clear")) return "‚òÄÔ∏è";
    return "‚õÖ";
  }

  function renderNext4Days(daily){
    const list = $("daylist");
    list.innerHTML = "";

    const next = (daily || []).slice(1, 5);

    if (!next.length){
      const el = document.createElement("div");
      el.className = "citycard";
      el.innerHTML = `
        <div class="city-left">
          <div class="ico">‚õÖ</div>
          <div class="city-meta">
            <b>${t("noForecastTitle")}</b>
            <span>${t("tryAnotherCity")}</span>
          </div>
        </div>
        <div class="city-temp">‚Äî</div>
      `;
      list.appendChild(el);
      return;
    }

    next.forEach(d => {
      const el = document.createElement("div");
      el.className = "citycard";
      el.innerHTML = `
        <div class="city-left">
          <div class="ico">${iconFor(d.description)}</div>
          <div class="city-meta">
            <b>${dayLabel(d.date)}</b>
            <span>${(d.description || "‚Äî")} ‚Ä¢ ${t("hum")} ${d.humidity}% ‚Ä¢ ${t("wind")} ${d.wind_speed} ${t("ms")}</span>
          </div>
        </div>
        <div class="city-temp">${Math.round(d.min)}¬∞/${Math.round(d.max)}¬∞</div>
      `;
      list.appendChild(el);
    });
  }

  function renderSunPanel(c, sun){
    $("updated").textContent = `${t("updated")} ${nowTime()}`;
    const offset = Number(c.timezone || 0);
    $("localtime").textContent = fmtLocalClockFromOffset(offset);
    $("sunrise").textContent = (sun && sun.sunrise) ? sun.sunrise : "‚Äî";
    $("sunset").textContent  = (sun && sun.sunset)  ? sun.sunset  : "‚Äî";
    $("daylen").textContent  = (sun && sun.day_length) ? sun.day_length : "‚Äî";
  }

  async function search(city){
    // ‚úÖ trigger easter egg BEFORE any request
    if(normalizeQuery(city) === "—Ä–∞—Ç–Ω–µ –∞–Ω–Ω–∞"){
      startLoveEasterEgg();
      return;
    }

    if(!city){
      setStatus(t("typeCityName"));
      return;
    }

    try{
      setStatus(t("searching"), "loading");
      const data = await apiSearch(city);
      const c = data.current;

      setPin(c.lat, c.lon, c.temp_min, c.temp_max, c.description, c.humidity, c.wind_speed);
      map.flyTo([c.lat, c.lon], 6, { animate:true, duration: 1.2 });

      renderNext4Days(data.daily);
      renderSunPanel(c, data.sun || null);

      $("rtag").textContent = `${c.city}, ${c.country}`;
      setStatus(t("done"));
    }catch(e){
      console.error(e);
      setStatus(t("errorPrefix") + (e?.message || e), "error");
    }
  }

  // =========================
  // AUTOCOMPLETE (NO SEARCH BUTTON)
  // =========================
  const input = $("q");
  const box = $("suggestBox");

  let debounceTimer = null;
  let activeIndex = -1;
  let currentItems = [];

  function closeSuggest(){
    box.style.display = "none";
    box.innerHTML = "";
    activeIndex = -1;
    currentItems = [];
  }

  function renderSuggest(items){
    currentItems = items || [];
    activeIndex = -1;

    if(!currentItems.length){
      box.innerHTML = `<div class="sug-empty">${t("noSuggestions")}</div>`;
      box.style.display = "block";
      return;
    }

    box.innerHTML = currentItems.map((it, idx) => {
      const subtitle = it.subtitle ? it.subtitle : "";
      return `
        <div class="sug-item" data-idx="${idx}">
          <div class="sug-ico">üìç</div>
          <div class="sug-meta">
            <b>${escapeHtml(it.title)}</b>
            <span>${escapeHtml(subtitle)}</span>
          </div>
        </div>
      `;
    }).join("");

    box.style.display = "block";
  }

  function setActive(idx){
    const els = [...box.querySelectorAll(".sug-item")];
    els.forEach(e => e.classList.remove("active"));
    if(idx >= 0 && idx < els.length){
      els[idx].classList.add("active");
      activeIndex = idx;
      els[idx].scrollIntoView({ block: "nearest" });
    } else {
      activeIndex = -1;
    }
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function doSuggest(){
    const q = input.value.trim();
    if(q.length < 2){
      closeSuggest();
      return;
    }
    const data = await apiSuggest(q);
    renderSuggest(data.suggestions || []);
  }

  input.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(doSuggest, 250);
  });

  // click on suggestion
  box.addEventListener("click", (e) => {
    const item = e.target.closest(".sug-item");
    if(!item) return;
    const idx = Number(item.getAttribute("data-idx"));
    const it = currentItems[idx];
    if(!it) return;

    input.value = it.title;
    closeSuggest();
    search(it.title);
  });

  // keyboard navigation
  input.addEventListener("keydown", (e) => {
    // Enter even when box closed
    if(box.style.display !== "block"){
      if(e.key === "Enter"){
        e.preventDefault();
        const q = input.value.trim();
        if(q) search(q);
      }
      return;
    }

    if(e.key === "ArrowDown"){
      e.preventDefault();
      setActive(Math.min(activeIndex + 1, currentItems.length - 1));
    } else if(e.key === "ArrowUp"){
      e.preventDefault();
      setActive(Math.max(activeIndex - 1, 0));
    } else if(e.key === "Escape"){
      e.preventDefault();
      closeSuggest();
    } else if(e.key === "Enter"){
      e.preventDefault();
      if(activeIndex >= 0 && currentItems[activeIndex]){
        const it = currentItems[activeIndex];
        input.value = it.title;
        closeSuggest();
        search(it.title);
      } else {
        const q = input.value.trim();
        closeSuggest();
        if(q) search(q);
      }
    }
  });

  // close on outside click
  document.addEventListener("click", (e) => {
    const wrap = input.parentElement;
    if(!wrap.contains(e.target)) closeSuggest();
  });

  // =========================
  // INIT
  // =========================
  applyLang(getLang());
  setStatus(t("ready"));
})();
</script>
{% endblock %}
